# Kyocera FS-1040 Printer Working on BananaPi ARM

## Success!

The Kyocera FS-1040 printer is now successfully working on the BananaPi (ARMv7) using the **libusb backend** with CUPS.

## Key Solution

The critical fix was switching from the `usblp` kernel module to CUPS' libusb backend:

1. **Remove usblp module**: `modprobe -r usblp`
2. **Blacklist usblp**: Create `/etc/modprobe.d/blacklist-usblp.conf`
3. **Use proper USB URI**: `usb://Kyocera/FS-1040?serial=V235751419`
4. **CUPS handles USB communication**: The libusb backend properly handles USB printer class control transfers

## What Was The Problem?

The Kyocera FS-1040 requires specific USB initialization/handshake that the raw `/dev/usb/lp0` device doesn't provide. The CUPS libusb backend implements the proper USB printer class protocol including:
- Control transfers for printer status
- Proper USB endpoints configuration
- Correct data flow management

## Current Working Configuration

- **Printer Name**: Kyocera-FS1040
- **URI**: `usb://Kyocera/FS-1040?serial=V235751419`
- **Driver**: Kyocera PPD with rastertokpsl filter (via qemu-i386)
- **Backend**: CUPS libusb (not usblp kernel module)
- **Network Sharing**: Enabled via IPP/CUPS on port 631
- **Discovery**: Avahi/mDNS advertising as "_ipp._tcp"

## Test Printing

```bash
# Local test
echo "Test page" | lp -d Kyocera-FS1040

# Network test from another device
lp -d ipp://bananapi.local:631/printers/Kyocera-FS1040 /path/to/file
```

## Android Printing

The printer is now discoverable by Android devices on the same network:
- Shows up as "Kyocera-FS1040 @ bananapi"
- Works with Android's built-in printing service
- No additional apps required

## Technical Details

### KPSL Format
The printer uses Kyocera Page Streaming Language (KPSL):
- Header starts with "LSPK" (KPSL backwards)
- Binary format specific to Kyocera printers
- Generated by rastertokpsl filter

### ARM Compatibility
Using qemu-i386-static to run the official i386 rastertokpsl binary:
```bash
LD_LIBRARY_PATH=/usr/lib/i386-linux-gnu:/lib/i386-linux-gnu \
/usr/bin/qemu-i386-static -L /usr/lib/i386-linux-gnu \
/usr/lib/cups/filter/rastertokpsl-bin "$@"
```

## Files Modified

- `/etc/cups/cupsd.conf` - CUPS configuration for network sharing
- `/etc/avahi/avahi-daemon.conf` - Avahi configuration (interface: end0)
- `/usr/lib/cups/filter/rastertokpsl` - Filter wrapper script
- `/etc/modprobe.d/blacklist-usblp.conf` - Blacklist usblp module
- `setup-printer-sharing.sh` - Updated setup script with working configuration

## Important Notes

1. **Do NOT load usblp module** - It interferes with libusb backend
2. **Printer must be powered on** before adding to CUPS
3. **Test pages work** - Confirmed printing works with libusb backend
4. **Network discovery works** - Avahi properly advertising the printer

## Troubleshooting

If printing stops working:
1. Check usblp isn't loaded: `lsmod | grep usblp`
2. Verify USB URI: `lpinfo -v | grep usb://`
3. Check CUPS status: `systemctl status cups`
4. View logs: `tail -f /var/log/cups/error_log`

## Credits

Success achieved by:
- Switching from usblp to libusb backend (critical fix)
- Using qemu-user-static for x86 binary compatibility
- Proper USB printer class protocol handling by CUPS
- Community reverse-engineering efforts (rastertokpsl-re project)